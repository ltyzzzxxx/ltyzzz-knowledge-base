---
title: Redis 集群
---

## 问题清单

::: tip Questions
1.   **Redis 主从复制如何实现？**

2.   **从服务器宕机或出现网络故障，如何保证主从一致性？**

3.   **主从模式下，如何判断某个节点是否正常工作？**

4.   **主从复制中，出现的 replication buffer 和 repl_backlog_buffer 有什么区别？**

5.   **主从切换如何减少数据丢失？**

6.   **Sentinel 哨兵节点作用是什么？**

7.   **Sentinel 如何判断主节点是否宕机？**

8.   **由哪个 Sentinel 节点完成最终的故障转移？**

9.   **Leader Sentinel 如何选出新的主节点？**

10.  **Sentinel 集群如何组成？**

11.  **Redis 如何保证高可用？**
::: 

## 问题回答

1.   **Redis 主从复制如何实现？**
::: info Answer
  主从通过 `replicaof` 实现主从关系

  第一次同步共有建立连接、同步数据、发送写命令三个阶段

  -   建立连接

      从机会向主机发送 `psync` 命令，表示需要进行数据同步

      `psync` 命令包含两个参数：主服务器 `runID` 与复制进度 `offset`

      -   `runID`：每个 `redis` 启动时都会随机生成一个 `ID`。由于第一次主从复制时，从机并不知道主机的 `runID`，所以为 `?`

      -   `offset`：表示复制的进度。第一次复制时，该值为-1

      主机收到命令后，由于是第一次主从复制，会执行完整同步操作，会返回 `FULLERSYNC` 并携带 `runID` 与 `offset`。

      从服务器收到后，会记录这两个值。

  -   同步数据

      主服务器执行 `bgsave` 命令生成 `RDB` 文件，并发送给从服务器

      从服务器收到 `RDB` 文件后，先清空当前数据库，然后载入 `RDB` 文件

      为了保证复制期间主从一致性，主服务器会将复制期间执行的写命令，写入到 `replication buffer` 缓冲区中

  -   主服务器发送写命令到从服务器

      从服务器完成 `RDB` 载入后，会发送一个确认消息给主服务器。

      主服务器收到后，便将 `replication buffer` 中的写命令发送给从服务器，从服务器执行，此时达成数据一致

  第一次主从复制之后，双方之间会维护一个 `TCP` 连接，主服务器可以将写命令传播给从服务器，此过程为命令传播
:::

2.   **从服务器宕机或出现网络故障，如何保证主从一致性？**
::: info Answer
  Redis 2.8 之前，仍然采用全量复制保证主从一致性，即网络恢复或从服务器恢复后，再次与主从服务器执行全量同步。

  Redis 2.8 之后，采用新的增量复制方式

  -   从服务器恢复后，发送psync命令给主服务器，并携带之前存储的参数 `runID` 与 `offset`

  -   主服务器收到命令后，回复CONTINUE响应告诉从服务器接下来采用增量复制来恢复数据

  -   主服务器发送这段时间内的写命令给从服务器

  通过一个环形缓冲区与各自的同步偏移量，来确定发送哪些写命令给从服务器

  -   repl_backlog_buffer：复制积压环形缓冲区

  -   replication offset：主服务器标记写进度，从服务器标记读进度

  主服务器在进行命令传播时，不止会将写命令发送给从服务器，还会存储写命令到 `repl_backlog_buffer` 中

  当网络恢复后，从服务器会将自己的复制偏移量 `offset` 发送给主服务器，主服务器根据两个偏移量，确定同步方式

  -   若从服务器需要读取的数据还在 `repl_backlog_buffer` 中，采取增量复制

  -   否则，采取全量复制

  repl_backlog_buffer默认大小为 1MB，当缓冲区写满后，如果继续写入，将会覆盖之前的数据（固定长度的 `FIFO` 队列）

  为了网络恢复后，主服务器采取全量复制，需要调整 `repl_backlog_buffer` 的大小

  ```
  second * write_size_per_second
  ```
:::

3.   **主从模式下，如何判断某个节点是否正常工作？**
::: info Answer
  -   主节点默认 10s 去 ping 一次从节点，判断节点是否存活

  -   从节点默认 1s 发送一次 `replconf ack{offset}` 命令，给主节点上报自身当前的复制偏移量

      -   实时监测主节点网络状态

      -   上报自身复制偏移量，防止出现命令丢失情况
:::

4.   **主从复制中，出现的 replication buffer 和 repl_backlog_buffer 有什么区别？**
::: info Answer
  -   replication buffer：主节点会为每一个从节点分配，因为不同从节点连接并开始进行主从复制的时间不同，所以后续发送的写命令也不同，需要单独管理

  -   repl_backlog_buffer：只用于增量复制阶段，只存在于主节点中

  并且当 `replication_buffer` 满了之后，会导致连接断开，并重新连接，重新进行主从复制
:::

5.   **主从切换如何减少数据丢失？**
::: info Answer
  -   异步复制同步丢失

      主节点还没来得及将数据同步给从节点时，主节点宕机，造成数据丢失

      -   通过配置 `min-slaves-max-lag`，一旦所有从节点数据复制和同步延迟超过了该值，主节点会拒绝任何请求。

          即使主节点宕机，损失的数据这只是该值时间内的数据。

      -   客户端发现主节点拒绝请求后，可以采取降级措施，将数据存储在本地缓存或数据库中，等恢复后再重新写入。也可以写入消息队列

  -   集群脑裂现象

      当主节点与从节点之间出现网络故障时，无法实现主从命令传播，而 `Sentinel` 节点会判断主节点宕机，重新选举出新的主节点。

      但此时客户端与主节点之间通信正常，还会继续发送写请求。而主节点被降级为从节点后，会清空自身数据，导致客户端写入的数据全部丢失。

      当主节点发现「从节点下线的数量太多」，或者「网络延迟太大」的时候，那么主节点会禁止写操作，直接把错误返回给客户端。

      在 Redis 的配置文件中有两个参数我们可以设置：

      -   min-slaves-to-write x，主节点必须要有**至少 x 个从节点连接**，如果小于这个数，主节点会禁止写数据。
      -   min-slaves-max-lag x，主从数据复制和同步的延迟**不能超过 x 秒**，如果主从同步的延迟超过 x 秒，主节点会禁止写数据。
:::

6.   **Sentinel 哨兵节点作用是什么？**
::: info Answer
  主从节点故障转移。

  它会监测主节点是否存活，如果发现主节点挂了，它就会选举一个从节点切换为主节点，并且把新主节点的相关信息通知给从节点和客户端。
:::

7.   **Sentinel 如何判断主节点是否宕机？**
::: info Answer
  哨兵会每隔 1 秒给所有主从节点发送 PING 命令，当主从节点收到 PING 命令后，会发送一个响应命令给哨兵，这样就可以判断它们是否在正常运行。

  如果主节点或者从节点没有在规定的时间内响应哨兵的 PING 命令，哨兵就会将它们标记为「**主观下线**」。

  -   这个「规定的时间」是配置项 `down-after-milliseconds` 参数设定的，单位是毫秒。

  为了防止出现误判，会用多个节点组成哨兵集群

  当主观下线赞同票数达到哨兵配置文件中的 quorum 配置项设定的值后，这时主节点就会被该哨兵标记为「客观下线」。

  -   `quorum` 一般配置为 `哨兵个数 / 2 + 1`
:::

8.   **由哪个 Sentinel 节点完成最终的故障转移？**
::: info Answer
  由哨兵集群中的 `leader` 来进行故障转移

  `leader` 的选举过程为：

  1.   当主观下线赞成票数达到了当前哨兵的 `quorum` 配置值时，当前哨兵就会成为 `leader` 候选者

  2.   候选者会向其他哨兵发送命令，表明希望成为 `Leader` 来执行主从切换，并让所有其他哨兵对它进行投票。

       -  每个哨兵只有一次投票机会，如果用完后就不能参与投票了，可以投给自己或投给别人，但是只有候选者才能把票投给自己。

  3.   成为 `leader` 的条件为：

      1.   自身为 `leader` 候选者

      2.   拿到半数以上的赞成票

      3.   赞成票数大于 `quorum`
:::

9.   **Leader Sentinel 如何选出新的主节点？**
::: info Answer
  对所有从服务器进行筛选

  -   过滤掉所有处于下线状态的从节点

  -   过滤掉所有与主服务器连接断开超过 `down-after-milliseconds * 10` 毫秒的从服务器

  -   根据优先级、复制进度、ID 号依次进行排序：优先级高、复制偏移量大、ID 号小的节点

  之后将选出的节点升级为主节点，让其他从节点更换复制目标，并将旧的主节点变为从节点
:::

10.   **Sentinel 集群如何组成？**
::: info Answer
  **哨兵节点之间是通过 Redis 的发布者/订阅者机制来相互发现的**。

  在主从集群中，主节点上有一个名为 `__sentinel__:hello` 的频道，不同哨兵就是通过它来相互发现，实现互相通信的。

  哨兵 A 把自己的 IP 地址和端口的信息发布到 `__sentinel__:hello` 频道上，哨兵 B 和 C 订阅了该频道。那么此时，哨兵 B 和 C 就可以从这个频道直接获取哨兵 A 的 IP 地址和端口号。然后，哨兵 B、C 可以和哨兵 A 建立网络连接。

  Sentinel默认会以10s一次的频率，向主服务器发送INFO命令，获取其信息，其中包含有主服务器下的所有从服务器信息。

  根据此信息，Sentinel与其他从服务器建立命令连接与订阅连接
:::

11.   **Redis 如何保证高可用？**
::: info Answer
  主从复制、Sentinel集群、Cluster集群
:::