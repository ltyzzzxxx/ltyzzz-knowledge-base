---
title: Redis 性能评估
---

## 问题清单

::: tip Questions
1.   **如何评估 Redis 的性能？**

2.   **Redis 的慢查询功能是什么？如何使用它定位 Redis 性能瓶颈？**

3.   **Redis 内存碎片是什么？产生原因是什么？**

4.   **什么是 Big Key？**

5.   **Big Key的危害？**

6.   **如何避免或解决 Big Key 问题？**
::: 

## 问题回答

1.   **如何评估 Redis 的性能？**
::: info Answer
  可以从 5 个方面评估：性能 `Performance`、内存 `Memory`、基本活动 `Basic Activity`、持久性 `Persistence`、错误 `Error`

  对于性能：请求响应时间、每秒处理的请求数量、缓存命中率

  对于内存：内存占用率、内存碎片率、内存淘汰 `key` 的数量

  对于基本活动：客户端连接数、`key` 数量、`slave` 数量、最近一次主从交互时间

  对于持久性：最后一次持久化时间、最后一次持久化后数据库的更改次数

  对于错误：`key` 查找失败次数
:::

2.   **Redis 的慢查询功能是什么？如何使用它定位 Redis 性能瓶颈？**
::: info Answer
  慢查询日志功能用于记录执行时间超过给定时长的命令请求， 用户可以通过这个功能产生的日志来监视和优化查询速度。

  `Redis` 将所有的慢查询日志保存在 `slowlog` 链表中，每个链表节点为一个 `slowlogEntry` 结构，代表一条慢查询日志

  可以通过 `config set` 命令配置命令执行时间阈值与慢查询日志的最大长度

  超出最大长度，则将链表末尾日志移除，新日志位于链表头部
:::

3.   **Redis内存碎片是什么？产生原因是什么？**
::: info Answer
  Redis分配内存空间大于实际的占用空间，多余的部分即是内存碎片

  内存碎片形成原因分为内部原因与外部原因：

  -   底层内存分配器的分配策略无法真正做到按需分配，其按照一系列固定大小划分内存空间。当程序申请的内存接近某个固定值时，会分配相应的大小
  
  -   `key-value` 会被频繁的修改，造成空间的扩容或收缩
:::

4.   **什么是Big Key？**
::: info Answer
  大 `key` 并不是指 `key` 的值很大，而是 `key` 对应的 `value` 很大。

  一般而言，下面这两种情况被称为大 `key`：

  -   `String` 类型的值大于 `10` KB；

  -   `Hash`、`List`、`Set`、`ZSet` 类型的元素的个数超过 5000 个；
:::

5.   **Big Key 的危害？**
::: info Answer
  1.   减慢 `Redis` 持久化速度，加长服务端进程的阻塞时间

      -   `AOF` 后台重写时 `fork` 子进程，如果数据过大，会造成页表过大，加长 `fork` 时间，进而长时间阻塞主进程

      -   `AOF` 持久化追加命令到 `AOF` 文件中时，最终需要将其落入磁盘中，如果数据过大，会加长这一过程，进而长时间阻塞主进程

      -   `AOF` 和 `RDB` 后台执行时，有可能发生写时复制，如果数据过大，则会造成物理内存复制时间过长，进而长时间阻塞主进程

  2.   客户端请求时间超长甚至超时，响应速度慢

  3.   对 `Big Key` 的读取、更新等操作会阻塞服务端进程

  4.   引起流量高峰，可能使 `Redis` 服务器崩溃

  5.   `Big Key` 过大或过多时，会造成 `OOM` 错误，也可能导致重要的 `key` 由于内存淘汰策略被删除

  6.   影响主从同步
:::

6.   **如何避免或解决 Big Key 问题？**
::: info Answer
  1.   设计阶段将可能存在的 `Big Key` 进行拆分，通过 `hash` 数据结构进行存储

  2.   通过 `redis-cli --bigkeys` 命令找到 `Big Key`，并通过 `unlink` 命令将其异步删除

  3.   实时对 `Redis` 进行性能指标监控

  4.   定期清理失效的 `key`，防止内存溢出
:::