---
title: Redis 应用
---

## 问题清单

::: tip Questions
1.   **Redis 如何实现延时队列？**

2.   **Redis 限流器如何实现？有哪些常见的限流算法？**

3.   **如何用 Redis 实现动态 feed 流？**

4.   **布隆过滤器原理是什么？**
::: 

## 问题回答

1.   **Redis 如何实现延时队列？**
::: info Answer
  采用 `String` 与 `SortedSet` 数据结构实现

  对于 `Push` 操作

  -   采用 `String`：生成随机 `UUID` 作为 `key`，具体数据作为 `value`

  -   采用 `SortedSet`：将 `key` 添加到 `SortedSet` 中，`score` 为当前时间戳

  对于 `Pop` 操作

  -   计算 `previous` 秒之前的时间戳，使用 `SortedSet` 的 `zrangebyscore` 方法获取这个时间之前的所有 `key` 值

  -   利用 `Redis` 删除的原子性，删掉 `SortedSet` 中的 `key`

  -   通过这些 `key`，定位到 `String` 中的 `value` 值，得到真正的数据
:::

2.   **Redis 限流器如何实现？有哪些常见的限流算法？**
::: info Answer
  Redis + lua 脚本实现令牌桶限流器

  1.   用户发起请求，经过网关或拦截器或AOP前置方法

  2.   Redis 生成令牌：`(当前时间 - 最后一次生成令牌的时间) / 1000 * 每秒生成令牌数量`

  3.   放入桶中：若生成令牌数大于 0，则更新最后一次生成令牌时间；生成令牌数加剩余令牌数大于桶容量，取桶容量

  4.   取出令牌：桶中剩余令牌小于所取令牌数，则全部取出；否则只取固定数量

  5.   获取到令牌则放行请求

  漏桶算法、固定窗口算法、计数器算法
:::

3.   **如何用 Redis 实现动态 feed 流？**
::: info Answer
  1.   当用户 `A` 发布视频时，写入 `Redis` 该用户对应的 `sendbox` 中，将该条消息封装，发送给消息队列

  2.   消息队列根据 `A` 用户的粉丝列表，并判断当前粉丝是否为活跃用户

      -   若是，则将此消息添加到粉丝的 `inbox` 中

      -   若不是，则不做处理

  3.   用户登陆时，首先从 `inbox` 中获取动态，若判断用户不是活跃用户，则遍历其关注列表的 `sendbox`，添加到 `inbox`

  4.   `feed` 数据清理：定时任务清理大于 300 条以上的最早的数据
:::

4.  **布隆过滤器原理是什么？**
::: info Answer
布隆过滤器主要是由位数组和 `hash` 函数构成的

-   位数组初始状态都为 0

-   哈希函数用于对 `key` 进行计算，并得到该 `key` 对应于位数组的位置

-   判断元素是否存在

    1.   先通过多个哈希函数得到当前元素的多个哈希值，并进行取余，得到多个位数组的位置

    2.   判断多个位置上是否都为 1

         -   若其中有一个为 0，则说明元素不存在

         -   若都为 1，则说明元素有可能存在

应用场景：

-   解决缓存穿透问题：先查看布隆过滤器，再查看 `Redis`，最后查看 `MySQL`

-   判断用户是否看过某帖子、某视频、某网站

-   爬虫系统对已爬取的页面去重
:::